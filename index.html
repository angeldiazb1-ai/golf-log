<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Golf Log</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f5132">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root{
  --bg:#061d14;
  --card:#123a2a;
  --soft:#1b4d38;
  --accent:#4ade80;
  --warn:#facc15;
  --danger:#ef4444;
  --text:#e6f4ec;
  --muted:#b7d6c7;
  --radius:18px;
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;}
html,body{margin:0;padding:0;background:radial-gradient(circle at top,#0f5132,var(--bg));color:var(--text);overflow-x:hidden;}
h1{font-size:36px;margin:16px 0;}
h2{margin:0 0 12px;font-size:20px;}
.card{background:linear-gradient(180deg,var(--soft),var(--card));border-radius:var(--radius);padding:18px;margin-bottom:18px;}
.segmented{display:flex;flex-wrap:wrap;gap:10px;}
.seg-btn{flex:1;min-width:90px;padding:12px;border-radius:14px;border:none;background:#1e5b43;color:var(--text);font-size:17px;}
.seg-btn.active{background:var(--accent);color:#062317;font-weight:700;}
input,select{width:100%;padding:14px;font-size:18px;border-radius:14px;border:2px solid #2e7d5b;background:#0d2f22;color:var(--text);}
.row{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap;}
.action{flex:1;padding:14px;font-size:18px;border-radius:14px;border:none;font-weight:700;}
#guardarBtn{background:var(--accent);color:#062317;}
#deshacerBtn{background:var(--warn);color:#3a2a00;}
.pill{display:flex;justify-content:space-between;align-items:center;background:#0d2f22;border-radius:999px;padding:10px 14px;font-size:14px;margin-top:10px;gap:10px;}
.badge{min-width:80px;padding:8px 12px;border-radius:999px;font-weight:700;text-align:center;display:inline-block;}
.ok{background:var(--accent);color:#062317;}
.bad{background:var(--danger);}
.neutral{background:#64748b;}
.tableWrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{min-width:620px;width:100%;border-collapse:collapse;font-size:14px;}
th,td{padding:8px;border-bottom:1px solid #1f5b3f;text-align:center;white-space:nowrap;}
/* Dispersión */
.dispGrid{display:flex;gap:10px;flex-wrap:wrap;}
.dispItem{flex:1;min-width:120px;background:#0d2f22;border-radius:14px;padding:12px;}
.dispItem .k{font-size:12px;color:var(--muted);}
.dispItem .v{font-size:18px;font-weight:800;margin-top:6px;}
.barWrap{background:#0d2f22;border-radius:14px;overflow:hidden;height:14px;margin-top:10px;border:1px solid #1f5b3f;}
.bar{height:100%;display:flex;width:100%;}
.bar > div{height:100%;}
.barL{background:var(--danger);}
.barC{background:var(--accent);}
.barR{background:var(--danger);opacity:0.75;}
footer{text-align:center;font-size:12px;color:var(--muted);margin:20px 0;}
</style>
</head>

<body>
<h1>Golf Log</h1>

<!-- MODO -->
<section class="card">
  <div class="segmented" id="modoButtons">
    <button class="seg-btn active" data-modo="range">Range</button>
    <button class="seg-btn" data-modo="zona">Zona</button>
    <button class="seg-btn" data-modo="evaluacion">Evaluación</button>
    <button class="seg-btn" data-modo="objetivo">Objetivo</button>
  </div>
</section>

<!-- PALO -->
<section class="card">
<h2>Palo</h2>
<div class="segmented" id="paloButtons">
  <button class="seg-btn active">Driver</button>
  <button class="seg-btn">H3</button>
  <button class="seg-btn">H4</button>
  <button class="seg-btn">5i</button>
  <button class="seg-btn">6i</button>
  <button class="seg-btn">7i</button>
  <button class="seg-btn">8i</button>
  <button class="seg-btn">9i</button>
  <button class="seg-btn">PW</button>
  <button class="seg-btn">SW56</button>
  <button class="seg-btn">Putter</button>
</div>
</section>

<!-- ZONA -->
<section class="card" id="zonaPanel" style="display:none;">
<h2>Zona</h2>
<div class="muted">Rango fijo 0–300 m</div>
<select id="zonaSelect"></select>
<div class="pill"><span>Zona:</span><strong id="zonaActual">—</strong></div>
</section>

<!-- DIRECCIÓN -->
<section class="card">
<h2>Dirección</h2>
<div class="segmented" id="direccionButtons">
  <button class="seg-btn">Izq</button>
  <button class="seg-btn active">Centro</button>
  <button class="seg-btn">Der</button>
</div>
</section>

<!-- DISTANCIA -->
<section class="card">
<h2>Distancia (m)</h2>
<input id="distancia" inputmode="numeric" placeholder="Ej. 183">
<div class="row">
  <button id="guardarBtn" class="action">Guardar golpe</button>
  <button id="deshacerBtn" class="action">Deshacer</button>
</div>
<div class="pill" id="ultimoInfo">Último: —</div>
</section>

<!-- HISTORIAL -->
<section class="card">
<h2>Historial</h2>

<div class="segmented" id="histViewButtons" style="margin-bottom:10px;">
  <button class="seg-btn active" data-view="session">Sesión</button>
  <button class="seg-btn" data-view="total">Totales</button>
</div>

<div class="row" style="margin-top:0;">
  <button id="nuevaSesionBtn" class="action" style="background:#60a5fa;color:#081827;">Nueva sesión</button>
</div>

<div class="pill"><span>Sesión actual:</span><strong id="sesionInfo">—</strong></div>

<div class="tableWrap">
<table>
<thead>
<tr><th>#</th><th>Modo</th><th>Palo</th><th>Dir</th><th>m</th><th>Eval</th></tr>
</thead>
<tbody id="history"></tbody>
</table>
</div>
</section>

<!-- DISPERSIÓN -->
<section class="card">
<h2>Dispersión (Sesión)</h2>
<div class="dispGrid">
  <div class="dispItem">
    <div class="k">Izq</div>
    <div class="v" id="dispL">—</div>
  </div>
  <div class="dispItem">
    <div class="k">Centro</div>
    <div class="v" id="dispC">—</div>
  </div>
  <div class="dispItem">
    <div class="k">Der</div>
    <div class="v" id="dispR">—</div>
  </div>
</div>
<div class="barWrap" aria-label="barra de dispersión">
  <div class="bar">
    <div class="barL" id="barL" style="width:0%"></div>
    <div class="barC" id="barC" style="width:0%"></div>
    <div class="barR" id="barR" style="width:0%"></div>
  </div>
</div>
<div class="pill" style="margin-top:10px;">
  <span>Sesgo (Izq↔Der):</span>
  <strong id="dispBias">—</strong>
</div>
</section>

<footer>Golf Log · B3.0 (dispersión por sesión) · PWA</footer>

<script>
/* ===== ESTADO / STORAGE ===== */
const STORAGE="golf-log-data";

function genSessionId(){
  return "s_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7);
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

let state = (()=>{
  let s = null;
  try{ s = JSON.parse(localStorage.getItem(STORAGE)); }catch(e){}
  if(!s) s = {};

  // Base
  if(!Array.isArray(s.shots)) s.shots = [];
  if(!s.modo) s.modo = "range";
  if(!s.palo) s.palo = "Driver";
  if(!s.dir) s.dir = "Centro";
  if(typeof s.zonaKey === "undefined") s.zonaKey = null;

  // Sesiones (nuevo formato)
  if(!s.session || !s.session.id){
    s.session = { id: genSessionId(), n: 1 };
  }
  if(typeof s.nextSessionNum !== "number") s.nextSessionNum = (s.session?.n || 1) + 1;
  if(!s.historyView) s.historyView = "session";

  // MIGRACIÓN: sessionId en tiros
  s.shots.forEach(sh=>{
    if(!sh.sessionId){
      sh.sessionId = s.session.id;
    }else if(typeof sh.sessionId !== "string"){
      sh.sessionId = "legacy_" + String(sh.sessionId);
    }
    // asegurar estructura mínima
    if(!sh.dir) sh.dir = "Centro";
    if(!sh.palo) sh.palo = "Driver";
    if(!sh.modo) sh.modo = "range";
  });

  // Si la sesión actual no tiene tiros pero hay tiros, apuntar a la última sesión existente
  const hasCurrent = s.shots.some(sh=>sh.sessionId===s.session.id);
  if(!hasCurrent && s.shots.length){
    const last = s.shots[s.shots.length-1];
    s.session.id = last.sessionId;
  }

  return s;
})();

function save(){ localStorage.setItem(STORAGE, JSON.stringify(state)); }

/* ===== HELPERS UI ⇄ ESTADO ===== */
function syncPaloFromUI(){
  const a = document.querySelector("#paloButtons .seg-btn.active");
  if(a) state.palo = a.textContent.trim();
}
function syncDirFromUI(){
  const a = document.querySelector("#direccionButtons .seg-btn.active");
  if(a) state.dir = a.textContent.trim();
}
function setActiveByText(selector, value){
  document.querySelectorAll(selector).forEach(btn=>{
    btn.classList.toggle("active", btn.textContent.trim()===value);
  });
}

/* ===== MODO ===== */
document.querySelectorAll("#modoButtons .seg-btn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll("#modoButtons .seg-btn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    state.modo=b.dataset.modo;
    zonaPanel.style.display=state.modo==="zona"?"block":"none";
    save(); render();
  };
});

/* ===== BOTONES GENÉRICOS ===== */
function group(sel, cb){
  document.querySelectorAll(sel).forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll(sel).forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      cb(b.textContent.trim());
      save(); // persistir selección también
    };
  });
}
group("#paloButtons .seg-btn", v=> state.palo=v);
group("#direccionButtons .seg-btn", v=> state.dir=v);

/* ===== ZONAS FIJAS 0–300 ===== */
const zonaSelect=document.getElementById("zonaSelect");
const zonaActual=document.getElementById("zonaActual");

function zonesFixed(step=15,max=300){
  const z=[]; let n=1;
  for(let s=0;s<max;s+=step){
    z.push({key:`Z${n}`,min:s,max:Math.min(max,s+step),label:`Z${n}: ${s}–${Math.min(max,s+step)} m`});
    n++;
  }
  return z;
}
function updateZona(){
  const zs=zonesFixed();
  zonaSelect.innerHTML = `<option value="">Selecciona zona…</option>` +
    zs.map(z=>`<option value="${z.key}" ${state.zonaKey===z.key?"selected":""}>${z.label}</option>`).join("");
  const z = zs.find(x=>x.key===state.zonaKey);
  zonaActual.textContent = z ? z.label : "—";
}
zonaSelect.onchange=e=>{ state.zonaKey=e.target.value||null; save(); render(); };

function evalZona(m){
  const z = zonesFixed().find(x=>x.key===state.zonaKey);
  if(!z) return {l:"—",c:"neutral"};
  if(m<z.min) return {l:"Corto",c:"bad"};
  if(m>z.max) return {l:"Largo",c:"bad"};
  return {l:"OK",c:"ok"};
}

/* ===== EVALUACIÓN ±5% POR PALO (no-Zona) ===== */
function statsByClub(){
  // solo tiros NO-Zona, porque Zona se evalúa distinto
  const map = {};
  state.shots.filter(sh=>sh.modo!=="zona").forEach(sh=>{
    const club = sh.palo || "—";
    if(!map[club]) map[club] = {n:0,sum:0};
    map[club].n += 1;
    map[club].sum += Number(sh.m)||0;
  });
  return map;
}

function evalClub(m, club){
  const st = statsByClub()[club] || {n:0,sum:0};
  // target base: si no hay tiros, usar la propia distancia como target (neutral)
  const learned = st.n >= 10;
  const target = learned ? (st.sum / st.n) : (st.n>0 ? (st.sum / st.n) : m);
  const tol = target * 0.05;

  let res = {l:"OK",c:"ok"};
  if(m < target - tol) res = {l:"Corto",c:"bad"};
  if(m > target + tol) res = {l:"Largo",c:"bad"};

  // meta para mostrar en "Último"
  res.meta = { target, tol, n: st.n, learned };
  return res;
}

/* ===== HISTORIAL VIEW ===== */
function setHistView(v){
  state.historyView = v;
  document.querySelectorAll("#histViewButtons .seg-btn").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.view===v);
  });
  save();
}

document.querySelectorAll("#histViewButtons .seg-btn").forEach(btn=>{
  btn.onclick=()=>{ setHistView(btn.dataset.view); render(); };
});

/* ===== SESIONES ===== */
function nuevaSesion(){
  syncPaloFromUI();
  syncDirFromUI();
  state.session = { id: genSessionId(), n: state.nextSessionNum };
  state.nextSessionNum += 1;
  save(); render();
}
nuevaSesionBtn.onclick = nuevaSesion;

/* ===== GUARDAR / DESHACER ===== */
guardarBtn.onclick=()=>{
  syncPaloFromUI();
  syncDirFromUI();

  const m = Number(distancia.value);
  if(!m || m<=0) return;

  const e = (state.modo==="zona")
    ? evalZona(m)
    : evalClub(m, state.palo);

  state.shots.push({
    modo: state.modo,
    palo: state.palo,
    dir: state.dir,
    m,
    eval: e,
    sessionId: state.session.id,
    t: Date.now()
  });

  distancia.value="";
  save(); render();
};

deshacerBtn.onclick=()=>{
  for(let i=state.shots.length-1;i>=0;i--){
    if(state.shots[i].sessionId===state.session.id){
      state.shots.splice(i,1);
      break;
    }
  }
  save(); render();
};

/* ===== DISPERSIÓN POR SESIÓN ===== */
function renderDispersion(sessionShots){
  const total = sessionShots.length;
  const counts = {Izq:0, Centro:0, Der:0};
  sessionShots.forEach(sh=>{
    const d = (sh.dir||"Centro").trim();
    if(d==="Izq") counts.Izq++;
    else if(d==="Der") counts.Der++;
    else counts.Centro++;
  });

  function fmt(k){
    if(!total) return "—";
    const pct = Math.round((counts[k]/total)*100);
    return `${pct}% (${counts[k]})`;
  }

  dispL.textContent = fmt("Izq");
  dispC.textContent = fmt("Centro");
  dispR.textContent = fmt("Der");

  const wL = total ? (counts.Izq/total)*100 : 0;
  const wC = total ? (counts.Centro/total)*100 : 0;
  const wR = total ? (counts.Der/total)*100 : 0;

  barL.style.width = wL.toFixed(1) + "%";
  barC.style.width = wC.toFixed(1) + "%";
  barR.style.width = wR.toFixed(1) + "%";

  // Sesgo: -1 Izq, 0 Centro, +1 Der (promedio)
  if(!total){
    dispBias.textContent = "—";
  }else{
    const score = (counts.Der - counts.Izq) / total; // -1..+1
    const pct = Math.round(Math.abs(score)*100);
    if(score > 0.05) dispBias.textContent = `Hacia Der (+${pct}%)`;
    else if(score < -0.05) dispBias.textContent = `Hacia Izq (-${pct}%)`;
    else dispBias.textContent = "Neutral";
  }
}

/* ===== RENDER ===== */
function render(){
  // panels
  zonaPanel.style.display = state.modo==="zona" ? "block" : "none";

  // sincronizar botones activos desde estado (por recargas)
  document.querySelectorAll("#modoButtons .seg-btn").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.modo===state.modo);
  });
  setActiveByText("#paloButtons .seg-btn", state.palo);
  setActiveByText("#direccionButtons .seg-btn", state.dir);

  // Zona UI
  updateZona();

  // Sesión label
  sesionInfo.textContent = `S${state.session?.n || 1}`;

  // Tabla: sesión o totales
  const shotsView = (state.historyView==="total")
    ? state.shots
    : state.shots.filter(sh=>sh.sessionId===state.session.id);

  const h = document.getElementById("history");
  h.innerHTML = "";
  shotsView.slice().reverse().forEach((s,i)=>{
    h.innerHTML += `<tr>
      <td>${shotsView.length-i}</td>
      <td>${s.modo}</td>
      <td>${s.palo}</td>
      <td>${s.dir}</td>
      <td>${s.m}</td>
      <td><span class="badge ${s.eval?.c || "neutral"}">${s.eval?.l || "—"}</span></td>
    </tr>`;
  });

  // Último (de la sesión actual)
  const lastSessionShot = [...state.shots].reverse().find(sh=>sh.sessionId===state.session.id);
  if(lastSessionShot){
    const u = lastSessionShot;
    const meta = (u.eval && u.eval.meta)
      ? ` <span style="color:var(--muted);">(target=${Math.round(u.eval.meta.target)} · n=${u.eval.meta.n}${u.eval.meta.learned?" ✓":""})</span>`
      : "";
    ultimoInfo.innerHTML = `Último: ${u.m} m → <span class="badge ${u.eval?.c || "neutral"}">${u.eval?.l || "—"}</span>${meta}`;
  }else{
    ultimoInfo.textContent = "Último: —";
  }

  // Dispersión SIEMPRE por sesión actual
  const sessionShots = state.shots.filter(sh=>sh.sessionId===state.session.id);
  renderDispersion(sessionShots);
}
render();

/* ===== SERVICE WORKER ===== */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js");
}
</script>
</body>
</html>
