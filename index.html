<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0c3b2e" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Golf Log</title>

  <link rel="manifest" href="manifest.webmanifest?v=B7.20260111.0222">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root {
      --bg:#082c23;
      --panel:#0c3b2e;
      --panel2:#0b3429;
      --text:#eaf7f2;
      --muted:#b7d9cd;
      --accent:#22c55e;
      --accent2:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
      --chip:#0f4a3a;
      --field:#1e2327;
      --field2:#111316;
      --border: rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 900px at 50% -100px, rgba(34,197,94,.22), transparent 55%),
                  radial-gradient(900px 700px at 100% 0, rgba(34,197,94,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      padding-bottom: env(safe-area-inset-bottom);
    }
    header{
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 18px 16px 12px 16px;
      background: linear-gradient(to bottom, rgba(8,44,35,.96), rgba(8,44,35,.72), rgba(8,44,35,0));
      backdrop-filter: blur(10px);
    }
    .title{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 20px;
    }
    .title .emoji{filter: drop-shadow(0 4px 10px rgba(0,0,0,.45));}
    main{padding: 0 16px 18px 16px; max-width: 720px; margin: 0 auto;}
    .card{
      background: linear-gradient(180deg, rgba(12,59,46,.92), rgba(11,52,41,.92));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      margin-top: 14px;
    }
    .grid{display:grid; gap: 12px;}
    .row{display:flex; gap: 12px; flex-wrap: wrap;}
    label{display:block; font-size: 13px; color: var(--muted); margin-bottom: 8px;}
    select,input,textarea{
      width:100%;
      background: linear-gradient(180deg, rgba(30,35,39,.98), rgba(17,19,22,.98));
      color: var(--text);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 14px 14px;
      font-size: 17px;
      outline: none;
    }
    input::placeholder{color: rgba(234,247,242,.45);}
    .seg{
      display:flex;
      gap: 8px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 6px;
      flex-wrap: wrap;
    }
    .seg button{
      flex: 1;
      min-width: 120px;
      background: transparent;
      color: var(--muted);
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 800;
      letter-spacing:.2px;
      cursor: pointer;
    }
    .seg button.active{
      background: rgba(34,197,94,.25);
      color: var(--text);
      border-color: rgba(34,197,94,.35);
    }
    .dir{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 14px 14px;
      font-size: 18px;
      font-weight: 900;
      cursor: pointer;
      color: var(--text);
      background: rgba(255,255,255,.06);
    }
    .btn.primary{background: rgba(34,197,94,.30); border-color: rgba(34,197,94,.35);}
    .btn.warn{background: rgba(245,158,11,.25); border-color: rgba(245,158,11,.35);}
    .btn.danger{background: rgba(239,68,68,.20); border-color: rgba(239,68,68,.35);}
    .btn:active{transform: translateY(1px);}
    .dir .btn.active{background: rgba(34,197,94,.32); border-color: rgba(34,197,94,.40);}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap: 12px;}
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 13px;
      color: var(--muted);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 999px;
      padding: 8px 10px;
    }
    .h2{font-size: 22px; font-weight: 900; margin: 0 0 8px 0;}
    .list{margin-top: 10px; display:grid; gap: 8px;}
    .item{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .item b{font-weight: 900;}
    .tabs{
      position: sticky;
      bottom: 0;
      z-index: 20;
      background: linear-gradient(to top, rgba(8,44,35,.98), rgba(8,44,35,.70), rgba(8,44,35,0));
      backdrop-filter: blur(10px);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom)) 12px;
    }
    .tabs .seg button{min-width: 0; flex: 1;}
    .hidden{display:none !important;}
    .small{font-size: 12px; color: rgba(234,247,242,.6);}
    .kpi{display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;}
    .kpi .box{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding: 12px;
    }
    .kpi .n{font-size: 22px; font-weight: 950;}
    .kpi .t{font-size: 12px; color: rgba(234,247,242,.65); margin-top: 2px;}
    .note{
      border-radius: 14px;
      padding: 12px;
      background: rgba(34,197,94,.12);
      border: 1px solid rgba(34,197,94,.20);
      color: rgba(234,247,242,.88);
    }
  </style>
</head>
<body>
  <header>
    <div class="title"><span class="emoji">⛳️</span> Golf Log – Práctica</div>
  </header>

  <main>
    <section class="card" id="cardRegistro">
      <div class="seg" id="modoSeg">
        <button class="seg-btn active" data-mode="range" type="button">Range</button>
        <button class="seg-btn" data-mode="zona" type="button">Zona</button>
        <button class="seg-btn" data-mode="evaluacion" type="button">Evaluación</button>
        <button class="seg-btn" data-mode="objetivo" type="button">Objetivos</button>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div>
          <label for="clubSel">Palo</label>
          <select id="clubSel"></select>
        </div>

        <div id="rowDist">
          <label for="distInput">Distancia (m)</label>
          <input id="distInput" inputmode="numeric" placeholder="Ej. 183" />
        </div>

        <div id="rowZona" class="hidden">
          <label for="zonaSel">Zona (rango fijo)</label>
          <select id="zonaSel"></select>
          <div class="small" id="zonaHint" style="margin-top:6px;"></div>
        </div>

        <div id="rowObjetivo" class="hidden">
          <label for="objSel">Objetivo</label>
          <select id="objSel"></select>
          <div class="small" id="objHint" style="margin-top:6px;"></div>
        </div>

        <div>
          <div class="row" style="align-items:center; justify-content:space-between;">
            <label style="margin:0;">Dirección</label>
            <span class="chip" id="jsChip">JS: cargando…</span>
          </div>
          <div class="dir" id="dirGrid">
            <button class="btn dir-btn" data-dir="Izq" type="button">Izq</button>
            <button class="btn dir-btn active" data-dir="Centro" type="button">Centro</button>
            <button class="btn dir-btn" data-dir="Der" type="button">Der</button>
          </div>
        </div>

        <div class="two">
          <button class="btn primary" id="guardarBtn" type="button">Guardar golpe</button>
          <button class="btn warn" id="deshacerBtn" type="button">Deshacer</button>
        </div>

        <div class="note" id="ultimaNote">Último: —</div>
      </div>
    </section>

    <section class="card hidden" id="cardDisp">
      <div class="h2">Dispersión</div>
      <div class="small">Conteo por dirección del modo/club actual (y sesión actual).</div>
      <div class="kpi" id="dispKpi"></div>
      <div class="small" style="margin-top:10px;">Tip: cambia <b>palo</b> o <b>modo</b> para ver otra dispersión.</div>
    </section>

    <section class="card hidden" id="cardSesion">
      <div class="row" style="align-items:baseline; justify-content:space-between;">
        <div>
          <div class="h2" style="margin-bottom:0;">Histórico – Sesión</div>
          <div class="small">Lo que registraste hoy (se borra con “Borrar sesión”).</div>
        </div>
        <button class="btn danger" id="borrarSesionBtn" type="button">Borrar sesión</button>
      </div>

      <div class="list" id="sesionList"></div>
      <div class="small" id="sesionEmpty" style="margin-top:10px;"></div>
    </section>

    <section class="card hidden" id="cardTotales">
      <div class="row" style="align-items:baseline; justify-content:space-between;">
        <div>
          <div class="h2" style="margin-bottom:0;">Totales</div>
          <div class="small">Resumen acumulado por palo (todas las sesiones).</div>
        </div>
        <button class="btn danger" id="borrarTodoBtn" type="button">Borrar todo</button>
      </div>

      <div class="list" id="totalesList"></div>
      <div class="small" id="totalesEmpty" style="margin-top:10px;"></div>
    </section>

    <section class="card hidden" id="cardBackup">
      <div class="h2">Backups</div>
      <div class="small">Exporta/importa tu base (JSON). Esto guarda y restaura: sesiones, totales y configuración.</div>

      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="exportBtn" type="button">Exportar JSON</button>
        <button class="btn" id="copiarBtn" type="button">Copiar</button>
      </div>

      <div style="margin-top:10px;">
        <label for="backupArea">JSON</label>
        <textarea id="backupArea" rows="10" placeholder='(Aquí aparecerá el JSON al exportar, o pega uno para importar)'></textarea>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn warn" id="importBtn" type="button">Importar JSON</button>
      </div>

      <div class="small" style="margin-top:10px;">Versión: <b>B7.20260111.0222</b></div>
    </section>
  </main>

  <div class="tabs">
    <div class="seg" id="tabSeg">
      <button class="tab-btn active" data-tab="registro" type="button">Registro</button>
      <button class="tab-btn" data-tab="disp" type="button">Dispersión</button>
      <button class="tab-btn" data-tab="sesion" type="button">Sesión</button>
      <button class="tab-btn" data-tab="totales" type="button">Totales</button>
      <button class="tab-btn" data-tab="backup" type="button">Backups</button>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const log = (...a) => console.log("[GolfLog]", ...a);
  window.addEventListener("error", (e) => console.log("[GolfLog][error]", e?.message, e?.filename, e?.lineno));
  window.addEventListener("unhandledrejection", (e) => console.log("[GolfLog][promise]", e?.reason));

  const $ = (id) => document.getElementById(id);

  const STORAGE_KEY = "golfLogDB_v7";
  const nowISO = () => new Date().toISOString();

  const defaultDB = () => ({
    version: "B7.20260111.0222",
    config: {
      mode: "range",
      club: "PW",
      dir: "Centro",
      zona: "Z120-140",
      objetivo: "OBJ_150",
    },
    sessionShots: [],
    allShots: [],
  });

  const CLUBS = ["Driver","3W","5W","3H","4H","5I","6I","7I","8I","9I","PW","SW56","LW60","Putter"];

  const ZONES = [
    ["Z60-80","60–80 m"],
    ["Z80-100","80–100 m"],
    ["Z100-120","100–120 m"],
    ["Z120-140","120–140 m"],
    ["Z140-160","140–160 m"],
    ["Z160-180","160–180 m"],
    ["Z180-200","180–200 m"],
    ["Z200-220","200–220 m"],
    ["Z220-240","220–240 m"],
    ["Z240-260","240–260 m"],
    ["Z260-280","260–280 m"],
    ["Z280-300","280–300 m"],
  ];

  const OBJECTIVES = [
    ["OBJ_100","Objetivo 100 m"],
    ["OBJ_120","Objetivo 120 m"],
    ["OBJ_140","Objetivo 140 m"],
    ["OBJ_150","Objetivo 150 m"],
    ["OBJ_160","Objetivo 160 m"],
    ["OBJ_180","Objetivo 180 m"],
    ["OBJ_200","Objetivo 200 m"],
    ["OBJ_220","Objetivo 220 m"],
  ];

  function loadDB() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return defaultDB();
      const db = JSON.parse(raw);
      if (!db || typeof db !== "object") return defaultDB();
      if (!Array.isArray(db.sessionShots)) db.sessionShots = [];
      if (!Array.isArray(db.allShots)) db.allShots = [];
      if (!db.config) db.config = defaultDB().config;
      return db;
    } catch (e) {
      console.log("[GolfLog] loadDB fail", e);
      return defaultDB();
    }
  }

  function saveDB() {
    try {
      db.version = "B7.20260111.0222";
      localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    } catch (e) {
      console.log("[GolfLog] saveDB fail", e);
      alert("No se pudo guardar (storage).");
    }
  }

  let db = loadDB();

  function fillSelect(sel, items, getVal, getText) {
    sel.innerHTML = "";
    for (const it of items) {
      const opt = document.createElement("option");
      opt.value = getVal(it);
      opt.textContent = getText(it);
      sel.appendChild(opt);
    }
  }

  function setActiveButtons(container, selector, predicate) {
    container.querySelectorAll(selector).forEach(btn => {
      btn.classList.toggle("active", predicate(btn));
    });
  }

  function showTab(tab) {
    const map = {
      registro: "cardRegistro",
      disp: "cardDisp",
      sesion: "cardSesion",
      totales: "cardTotales",
      backup: "cardBackup"
    };
    Object.values(map).forEach(id => $(id).classList.add("hidden"));
    $(map[tab]).classList.remove("hidden");
    setActiveButtons($("tabSeg"), ".tab-btn", b => b.dataset.tab === tab);

    if (tab === "disp") renderDispersion();
    if (tab === "sesion") renderSession();
    if (tab === "totales") renderTotals();
  }

  function showMode(mode) {
    db.config.mode = mode;
    setActiveButtons($("modoSeg"), ".seg-btn", b => b.dataset.mode === mode);

    const isZona = mode === "zona";
    const isObj = mode === "objetivo" || mode === "evaluacion";
    $("rowZona").classList.toggle("hidden", !isZona);
    $("rowObjetivo").classList.toggle("hidden", !isObj);

    renderDispersion();
    saveDB();
  }

  function currentTargetDistance() {
    if (db.config.mode === "zona") {
      const item = ZONES.find(z => z[0] === db.config.zona);
      if (!item) return null;
      const m = item[1].match(/(\d+)\D+(\d+)/);
      if (!m) return null;
      return Math.round((Number(m[1]) + Number(m[2])) / 2);
    }
    if (db.config.mode === "objetivo" || db.config.mode === "evaluacion") {
      const item = OBJECTIVES.find(o => o[0] === db.config.objetivo);
      if (!item) return null;
      const m = item[1].match(/(\d+)/);
      return m ? Number(m[1]) : null;
    }
    return null;
  }

  function evaluateShot(dist) {
    if (db.config.mode !== "evaluacion") return null;
    const target = currentTargetDistance();
    if (!target || !Number.isFinite(dist)) return null;
    const tol = Math.max(5, Math.round(target * 0.05));
    const ok = Math.abs(dist - target) <= tol;
    return ok ? "✅ OK" : "❌ Fuera";
  }

  function normalizeDistance(val) {
    const s = String(val ?? "").replace(",", ".").trim();
    if (!s) return null;
    const n = Number(s);
    if (!Number.isFinite(n)) return null;
    if (n <= 0 || n > 500) return null;
    return Math.round(n);
  }

  function renderLast() {
    const last = db.sessionShots[db.sessionShots.length - 1];
    if (!last) {
      $("ultimaNote").textContent = "Último: —";
      return;
    }
    const extra = last.eval ? ` · ${last.eval}` : "";
    $("ultimaNote").textContent = `Último: ${last.club} · ${last.dist} m · ${last.dir}${extra}`;
  }

  function renderSession() {
    const list = $("sesionList");
    list.innerHTML = "";
    if (!db.sessionShots.length) {
      $("sesionEmpty").textContent = "Sin tiros aún.";
      return;
    }
    $("sesionEmpty").textContent = "";
    [...db.sessionShots].slice().reverse().forEach(shot => {
      const div = document.createElement("div");
      div.className = "item";
      const left = document.createElement("div");
      left.innerHTML = `<b>${shot.club}</b> · ${shot.dist} m · ${shot.dir}` + (shot.eval ? ` · ${shot.eval}` : "");
      const right = document.createElement("div");
      right.className = "small";
      right.textContent = new Date(shot.ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      div.appendChild(left);
      div.appendChild(right);
      list.appendChild(div);
    });
  }

  function renderTotals() {
    const list = $("totalesList");
    list.innerHTML = "";
    const byClub = new Map();
    for (const s of db.allShots) {
      const key = s.club;
      if (!byClub.has(key)) byClub.set(key, []);
      byClub.get(key).push(s);
    }
    const keys = CLUBS.filter(c => byClub.has(c));
    if (!keys.length) {
      $("totalesEmpty").textContent = "Aún no hay datos acumulados.";
      return;
    }
    $("totalesEmpty").textContent = "";
    for (const club of keys) {
      const arr = byClub.get(club);
      const dists = arr.map(s=>s.dist);
      const avg = Math.round(dists.reduce((a,b)=>a+b,0)/dists.length);
      const min = Math.min(...dists);
      const max = Math.max(...dists);
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<div><b>${club}</b> · ${arr.length} tiros</div><div class="small">Prom ${avg} · Min ${min} · Max ${max}</div>`;
      list.appendChild(div);
    }
  }

  function renderDispersion() {
    const club = db.config.club;
    const mode = db.config.mode;
    const shots = db.sessionShots.filter(s => s.club === club && s.mode === mode);
    const counts = {Izq:0, Centro:0, Der:0};
    for (const s of shots) counts[s.dir] = (counts[s.dir]||0)+1;
    const total = shots.length || 0;

    const kpi = $("dispKpi");
    kpi.innerHTML = "";
    for (const d of ["Izq","Centro","Der"]) {
      const box = document.createElement("div");
      box.className = "box";
      const pct = total ? Math.round((counts[d]/total)*100) : 0;
      box.innerHTML = `<div class="n">${counts[d]}</div><div class="t">${d} · ${pct}%</div>`;
      kpi.appendChild(box);
    }
  }

  function renderHints() {
    const z = ZONES.find(x => x[0] === db.config.zona);
    $("zonaHint").textContent = z ? `Rango fijo: ${z[1]}` : "";

    const o = OBJECTIVES.find(x => x[0] === db.config.objetivo);
    const mode = db.config.mode;
    if (mode === "objetivo") $("objHint").textContent = o ? `Meta: ${o[1]}` : "";
    else if (mode === "evaluacion") {
      const t = currentTargetDistance();
      const tol = t ? Math.max(5, Math.round(t*0.05)) : null;
      $("objHint").textContent = (o && tol) ? `Objetivo: ${o[1]} (tolerancia ±${tol} m)` : "";
    } else {
      $("objHint").textContent = o ? o[1] : "";
    }
  }

  function setClub(club) {
    db.config.club = club;
    saveDB();
    renderDispersion();
  }

  function setDir(dir) {
    db.config.dir = dir;
    setActiveButtons($("dirGrid"), ".dir-btn", b => b.dataset.dir === dir);
    saveDB();
  }

  function saveShot() {
    const club = db.config.club;
    const dir = db.config.dir;
    const mode = db.config.mode;
    const dist = normalizeDistance($("distInput").value);
    if (!club) return alert("Selecciona un palo.");
    if (!dist) return alert("Ingresa una distancia válida (1–500).");

    const shot = {
      ts: nowISO(),
      club,
      dist,
      dir,
      mode,
      zona: db.config.zona,
      objetivo: db.config.objetivo,
      eval: evaluateShot(dist),
    };

    db.sessionShots.push(shot);
    db.allShots.push(shot);
    saveDB();

    $("distInput").value = "";
    renderLast();
    renderDispersion();
    if (!$("cardSesion").classList.contains("hidden")) renderSession();
    if (!$("cardTotales").classList.contains("hidden")) renderTotals();
  }

  function undoLast() {
    const last = db.sessionShots.pop();
    if (!last) return;
    for (let i = db.allShots.length - 1; i >= 0; i--) {
      const s = db.allShots[i];
      if (s.ts === last.ts && s.club === last.club && s.dist === last.dist && s.dir === last.dir) {
        db.allShots.splice(i, 1);
        break;
      }
    }
    saveDB();
    renderLast();
    renderDispersion();
    if (!$("cardSesion").classList.contains("hidden")) renderSession();
    if (!$("cardTotales").classList.contains("hidden")) renderTotals();
  }

  function clearSession() {
    if (!confirm("¿Borrar la sesión actual?")) return;
    const toRemove = new Set(db.sessionShots.map(s => s.ts + "|" + s.club + "|" + s.dist + "|" + s.dir));
    db.allShots = db.allShots.filter(s => !toRemove.has(s.ts + "|" + s.club + "|" + s.dist + "|" + s.dir));
    db.sessionShots = [];
    saveDB();
    renderLast();
    renderDispersion();
    renderSession();
    renderTotals();
  }

  function clearAll() {
    if (!confirm("¿Borrar TODO (sesiones y totales)?")) return;
    db = defaultDB();
    saveDB();
    $("distInput").value = "";
    $("backupArea").value = "";
    initUIFromDB();
    renderLast();
    renderDispersion();
    renderSession();
    renderTotals();
  }

  function exportJSON() {
    $("backupArea").value = JSON.stringify(db, null, 2);
  }

  function copyJSON() {
    const t = $("backupArea").value.trim();
    if (!t) return alert("No hay JSON para copiar.");
    navigator.clipboard?.writeText(t).then(() => alert("Copiado ✅")).catch(() => alert("No se pudo copiar."));
  }

  function importJSON() {
    const raw = $("backupArea").value.trim();
    if (!raw) return alert("Pega un JSON primero.");
    try {
      const obj = JSON.parse(raw);
      if (!obj || typeof obj !== "object") throw new Error("JSON inválido");
      if (!Array.isArray(obj.sessionShots) || !Array.isArray(obj.allShots)) throw new Error("Formato inválido");
      if (!obj.config) throw new Error("Formato inválido");
      db = obj;
      saveDB();
      initUIFromDB();
      renderLast();
      renderDispersion();
      renderSession();
      renderTotals();
      alert("Importado ✅");
    } catch (e) {
      console.log("[GolfLog] import fail", e);
      alert("No se pudo importar. Revisa el formato.");
    }
  }

  // iOS Safari reliable binding: delegation + pointerup/touchend/click
  function onTap(selector, handler) {
    const tap = (e) => {
      const el = e.target?.closest?.(selector);
      if (!el) return;
      e.preventDefault();
      handler(el, e);
    };
    document.addEventListener("pointerup", tap, true);
    document.addEventListener("touchend", tap, true);
    document.addEventListener("click", tap, true);
  }

  function initUIFromDB() {
    fillSelect($("clubSel"), CLUBS, x=>x, x=>x);
    $("clubSel").value = db.config.club || "PW";

    fillSelect($("zonaSel"), ZONES, z=>z[0], z=>z[1]);
    $("zonaSel").value = db.config.zona || ZONES[3][0];

    fillSelect($("objSel"), OBJECTIVES, o=>o[0], o=>o[1]);
    $("objSel").value = db.config.objetivo || OBJECTIVES[3][0];

    showMode(db.config.mode || "range");
    setDir(db.config.dir || "Centro");
    renderHints();
    renderLast();
    $("jsChip").textContent = "JS: activo ✓";
  }

  function bindEvents() {
    onTap(".tab-btn", (btn) => showTab(btn.dataset.tab));
    onTap("#modoSeg .seg-btn", (btn) => { showMode(btn.dataset.mode); renderHints(); });
    onTap("#dirGrid .dir-btn", (btn) => setDir(btn.dataset.dir));
    onTap("#guardarBtn", () => saveShot());
    onTap("#deshacerBtn", () => undoLast());
    onTap("#borrarSesionBtn", () => clearSession());
    onTap("#borrarTodoBtn", () => clearAll());
    onTap("#exportBtn", () => exportJSON());
    onTap("#copiarBtn", () => copyJSON());
    onTap("#importBtn", () => importJSON());

    $("clubSel").addEventListener("change", (e) => { setClub(e.target.value); renderHints(); });
    $("zonaSel").addEventListener("change", (e) => { db.config.zona = e.target.value; saveDB(); renderHints(); renderDispersion(); });
    $("objSel").addEventListener("change", (e) => { db.config.objetivo = e.target.value; saveDB(); renderHints(); renderDispersion(); });

    $("distInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); saveShot(); }
    });
  }

  async function registerSW() {
    try {
      if (!("serviceWorker" in navigator)) return;
      const reg = await navigator.serviceWorker.register("sw.js?v=B7.20260111.0222");
      log("SW registered", reg.scope);
    } catch (e) {
      console.log("[GolfLog] SW register fail", e);
    }
  }

  try {
    initUIFromDB();
    bindEvents();
    showTab("registro");
    registerSW();
    log("ready", "B7.20260111.0222");
  } catch (e) {
    console.log("[GolfLog] boot fail", e);
    alert("Error al iniciar. Revisa consola.");
  }
})();
</script>
</body>
</html>
