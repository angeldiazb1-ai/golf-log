<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Golf Log</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f5132">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root{
  --bg:#061d14;
  --card:#123a2a;
  --soft:#1b4d38;
  --accent:#4ade80;
  --warn:#facc15;
  --danger:#ef4444;
  --text:#e6f4ec;
  --muted:#b7d6c7;
  --radius:18px;
}

*{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;}
html,body{margin:0;padding:0;background:radial-gradient(circle at top,#0f5132,var(--bg));color:var(--text);overflow-x:hidden;}

h1{font-size:36px;margin:16px 0;}
h2{margin:0 0 12px;font-size:20px;}

.card{
  background:linear-gradient(180deg,var(--soft),var(--card));
  border-radius:var(--radius);
  padding:18px;
  margin-bottom:18px;
}

.segmented{display:flex;flex-wrap:wrap;gap:10px;}
.seg-btn{
  flex:1;
  min-width:90px;
  padding:12px;
  border-radius:14px;
  border:none;
  background:#1e5b43;
  color:var(--text);
  font-size:17px;
}
.seg-btn.active{background:var(--accent);color:#062317;font-weight:700;}

input,select{
  width:100%;
  padding:14px;
  font-size:18px;
  border-radius:14px;
  border:2px solid #2e7d5b;
  background:#0d2f22;
  color:var(--text);
}

.row{display:flex;gap:12px;margin-top:14px;}
.action{
  flex:1;
  padding:14px;
  font-size:18px;
  border-radius:14px;
  border:none;
  font-weight:700;
}
#guardarBtn{background:var(--accent);color:#062317;}
#deshacerBtn{background:var(--warn);color:#3a2a00;}

.pill{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#0d2f22;
  border-radius:999px;
  padding:10px 14px;
  font-size:14px;
  margin-top:10px;
}

.badge{
  min-width:80px;
  padding:8px 12px;
  border-radius:999px;
  font-weight:700;
  text-align:center;
}
.ok{background:var(--accent);color:#062317;}
.bad{background:var(--danger);}
.neutral{background:#64748b;}

.tableWrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{min-width:620px;width:100%;border-collapse:collapse;font-size:14px;}
th,td{padding:8px;border-bottom:1px solid #1f5b3f;text-align:center;white-space:nowrap;}

footer{text-align:center;font-size:12px;color:var(--muted);margin:20px 0;}
</style>
</head>

<body>

<h1>Golf Log</h1>

<!-- MODO -->
<section class="card">
  <div class="segmented" id="modoButtons">
    <button class="seg-btn active" data-modo="range">Range</button>
    <button class="seg-btn" data-modo="zona">Zona</button>
    <button class="seg-btn" data-modo="evaluacion">Evaluación</button>
    <button class="seg-btn" data-modo="objetivo">Objetivo</button>
  </div>
</section>

<!-- PALO -->
<section class="card">
<h2>Palo</h2>
<div class="segmented" id="paloButtons">
  <button class="seg-btn active">Driver</button>
  <button class="seg-btn">H3</button>
  <button class="seg-btn">H4</button>
  <button class="seg-btn">5i</button>
  <button class="seg-btn">6i</button>
  <button class="seg-btn">7i</button>
  <button class="seg-btn">8i</button>
  <button class="seg-btn">9i</button>
  <button class="seg-btn">PW</button>
  <button class="seg-btn">SW56</button>
  <button class="seg-btn">Putter</button>
</div>
</section>

<!-- ZONA -->
<section class="card" id="zonaPanel" style="display:none;">
<h2>Zona</h2>
<div class="muted">Rango fijo 0–300 m</div>
<select id="zonaSelect"></select>
<div class="pill"><span>Zona:</span><strong id="zonaActual">—</strong></div>
</section>

<!-- DIRECCIÓN -->
<section class="card">
<h2>Dirección</h2>
<div class="segmented" id="direccionButtons">
  <button class="seg-btn">Izq</button>
  <button class="seg-btn active">Centro</button>
  <button class="seg-btn">Der</button>
</div>
</section>

<!-- DISTANCIA -->
<section class="card">
<h2>Distancia (m)</h2>
<input id="distancia" inputmode="numeric" placeholder="Ej. 183">
<div class="row">
  <button id="guardarBtn" class="action">Guardar golpe</button>
  <button id="deshacerBtn" class="action">Deshacer</button>
</div>
<div class="pill" id="ultimoInfo">Último: —</div>
</section>

<!-- HISTORIAL -->
<section class="card">
<h2>Historial</h2>

<div class="segmented" id="histViewButtons" style="margin-bottom:10px;">
  <button class="seg-btn active" data-view="session">Sesión</button>
  <button class="seg-btn" data-view="total">Totales</button>
</div>

<div class="row" style="margin-top:0;">
  <button id="nuevaSesionBtn" class="action" style="background:#60a5fa;color:#081827;">Nueva sesión</button>
</div>

<div class="pill"><span>Sesión actual:</span><strong id="sesionInfo">—</strong></div>

<div class="tableWrap">
<table>
<thead>
<tr><th>#</th><th>Modo</th><th>Palo</th><th>Dir</th><th>m</th><th>Eval</th></tr>
</thead>
<tbody id="history"></tbody>
</table>
</div>
</section>

<footer>Golf Log · B1.2 (eval ±5% por palo + zonas fijas) · PWA</footer>

<script>
/* ===== ESTADO ===== */
const STORAGE="golf-log-data";

function genSessionId(){
  return "s_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7);
}

let state=JSON.parse(localStorage.getItem(STORAGE))||{
  modo:"range",
  palo:"Driver",
  dir:"Centro",
  zonaKey:null,

  // Sesiones
  session:{ id: genSessionId(), n: 1 },
  nextSessionNum: 2,
  historyView:"session", // "session" | "total"

  // Tiros (totales). Cada tiro lleva sessionId.
  shots:[],

  // Referencias iniciales (edítalas si lo deseas). Se usan hasta que el palo tenga suficiente historial.
  clubRef:{
    "Driver":200,"H3":185,"H4":175,"5i":165,"6i":155,"7i":145,"8i":135,"9i":125,"PW":110,"SW56":85,"Putter":5
  }
};

// Migraciones / defaults
if(!state.clubRef){
  state.clubRef={"Driver":200,"H3":185,"H4":175,"5i":165,"6i":155,"7i":145,"8i":135,"9i":125,"PW":110,"SW56":85,"Putter":5};
}
if(!state.session){
  state.session={ id: genSessionId(), n: 1 };
}
if(!state.nextSessionNum){
  state.nextSessionNum = (state.session?.n || 1) + 1;
}
if(!state.historyView){
  state.historyView = "session";
}
// Si hay tiros previos sin sessionId, asignarlos a una sesión "legacy"
if(Array.isArray(state.shots) && state.shots.length){
  let needsLegacy = false;
  for(const sh of state.shots){
    if(!sh.sessionId){ needsLegacy = true; sh.sessionId = "legacy"; }
  }
  if(needsLegacy){
    state.session = { id:"legacy", n:1 };
    state.nextSessionNum = 2;
  }
}

function save(){localStorage.setItem(STORAGE,JSON.stringify(state));}

/* ===== MODO ===== */
document.querySelectorAll("#modoButtons .seg-btn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll("#modoButtons .seg-btn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    state.modo=b.dataset.modo;
    zonaPanel.style.display=state.modo==="zona"?"block":"none";
    save();render();
  };
});

/* ===== BOTONES GENÉRICOS ===== */
function group(sel,cb){
  document.querySelectorAll(sel).forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll(sel).forEach(x=>x.classList.remove("active"));
      b.classList.add("active");cb(b.textContent);
    };
  });
}
group("#paloButtons .seg-btn",v=>{state.palo=v; save(); render();});
group("#direccionButtons .seg-btn",v=>{state.dir=v; save(); render();});


/* ===== HISTORIAL (SESIÓN / TOTALES) ===== */
const sesionInfo=document.getElementById("sesionInfo");

function setHistView(view){
  state.historyView=view;
  document.querySelectorAll("#histViewButtons .seg-btn").forEach(x=>{
    x.classList.toggle("active", x.dataset.view===view);
  });
}

document.querySelectorAll("#histViewButtons .seg-btn").forEach(b=>{
  b.onclick=()=>{
    setHistView(b.dataset.view);
    save();render();
  };
});

nuevaSesionBtn.onclick=()=>{
  const n = state.nextSessionNum || ((state.session?.n||1)+1);
  state.session = { id: genSessionId(), n };
  state.nextSessionNum = n + 1;
  // Al crear sesión nueva, nos quedamos viendo "Sesión"
  setHistView("session");
  save();render();
};

/* ===== ZONAS FIJAS 0–300 ===== */
const zonaSelect=document.getElementById("zonaSelect");
const zonaActual=document.getElementById("zonaActual");

function zonesFixed(step=15,max=300){
  const z=[];let n=1;
  for(let s=0;s<max;s+=step){
    z.push({key:`Z${n}`,min:s,max:Math.min(max,s+step),label:`Z${n}: ${s}–${Math.min(max,s+step)} m`});
    n++;
  }
  return z;
}
function updateZona(){
  const zs=zonesFixed();
  zonaSelect.innerHTML=`<option value="">Selecciona zona…</option>`+
    zs.map(z=>`<option value="${z.key}" ${state.zonaKey===z.key?"selected":""}>${z.label}</option>`).join("");
  const z=zs.find(x=>x.key===state.zonaKey);
  zonaActual.textContent=z?z.label:"—";
}
zonaSelect.onchange=e=>{state.zonaKey=e.target.value||null;save();render();};

function evalZona(m){
  const z=zonesFixed().find(x=>x.key===state.zonaKey);
  if(!z)return{l:"—",c:"neutral"};
  if(m<z.min)return{l:"Corto",c:"bad"};
  if(m>z.max)return{l:"Largo",c:"bad"};
  return{l:"OK",c:"ok"};
}


/* ===== EVALUACIÓN POR PALO (±5%) =====
Regla: Range / Evaluación / Objetivo evalúan por palo con tolerancia ±5% del target.
- Target inicial: state.clubRef[palo]
- Aprendizaje: cuando hay ≥10 tiros del palo (no-Zona), el target se calcula por promedio.
*/
function clubShots(palo){
  return state.shots.filter(s=>s.palo===palo && typeof s.m==="number" && s.m>0 && s.modo!=="zona");
}
function clubTarget(palo){
  const shots=clubShots(palo);
  const learned=shots.length>=10;
  if(learned){
    const avg=shots.reduce((a,s)=>a+s.m,0)/shots.length;
    return {target:avg, learned:true, n:shots.length};
  }
  // Si hay pocos tiros, usa promedio parcial (≥3) si existe, si no, referencia fija
  if(shots.length>=3){
    const avg=shots.reduce((a,s)=>a+s.m,0)/shots.length;
    return {target:avg, learned:false, n:shots.length};
  }
  return {target:(state.clubRef?.[palo] ?? 0), learned:false, n:shots.length};
}
function evalClub(m,palo){
  const info=clubTarget(palo);
  const t=info.target || 0;
  if(!t) return {l:"—",c:"neutral",meta:info};
  const tol=t*0.05;
  if(m < (t - tol)) return {l:"Corto",c:"bad",meta:info};
  if(m > (t + tol)) return {l:"Largo",c:"bad",meta:info};
  return {l:"OK",c:"ok",meta:info};
}

/* ===== GUARDAR ===== */
guardarBtn.onclick=()=>{
  const m=Number(distancia.value);if(!m)return;
  const e=(state.modo==="zona") ? evalZona(m) : evalClub(m,state.palo);
  state.shots.push({sessionId: state.session.id, modo:state.modo,palo:state.palo,dir:state.dir,m,eval:e});
  distancia.value="";save();render();
};

function undoLastInSession(){
  for(let i=state.shots.length-1;i>=0;i--){
    if(state.shots[i].sessionId===state.session.id){
      state.shots.splice(i,1);
      return true;
    }
  }
  return false;
}
deshacerBtn.onclick=()=>{undoLastInSession();save();render();};

/* ===== RENDER ===== */
function render(){
  updateZona();

  // Sesión actual (solo etiqueta)
  if(sesionInfo) sesionInfo.textContent = `S${state.session?.n || 1}`;

  // Asegurar estado visual de botones de vista
  setHistView(state.historyView || "session");

  // Shots para tabla: sesión o totales
  const shotsView = (state.historyView==="total")
    ? state.shots
    : state.shots.filter(sh=>sh.sessionId===state.session.id);

  const h=document.getElementById("history");
  h.innerHTML="";

  shotsView.slice().reverse().forEach((s,i)=>{
    h.innerHTML+=`<tr>
      <td>${shotsView.length-i}</td><td>${s.modo}</td><td>${s.palo}</td>
      <td>${s.dir}</td><td>${s.m}</td>
      <td><span class="badge ${s.eval.c}">${s.eval.l}</span></td>
    </tr>`;
  });

  // Último golpe = último de la sesión actual
  const lastSessionShot = [...state.shots].reverse().find(sh=>sh.sessionId===state.session.id);
  if(lastSessionShot){
    const u=lastSessionShot;
    const meta = (u.eval && u.eval.meta)
      ? ` <span style="color:var(--muted);">(target=${Math.round(u.eval.meta.target||0)} · n=${u.eval.meta.n}${u.eval.meta.learned?" ✓":""})</span>`
      : "";
    ultimoInfo.innerHTML=`Último: ${u.m} m → <span class="badge ${u.eval.c}">${u.eval.l}</span>` + meta;
  }else{
    ultimoInfo.textContent="Último: —";
  }
}
render();

/* ===== SW ===== */
if("serviceWorker"in navigator){navigator.serviceWorker.register("./sw.js");}
</script>

</body>
</html>
